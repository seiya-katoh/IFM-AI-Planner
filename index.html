<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFM AI Planner</title>
    <!-- ライブラリ一括読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root { color-scheme: dark; }
        body { 
            background-color: #000; 
            margin: 0; 
            font-family: 'Noto Sans JP', sans-serif;
            overflow-x: hidden;
            color: #fff;
        }

        /* Siri調流動背景アニメーション */
        @keyframes fluid-orbit-1 {
            0% { transform: translate(-30%, -30%) rotate(0deg) scale(1.1); }
            50% { transform: translate(30%, 30%) rotate(180deg) scale(1.6); }
            100% { transform: translate(-30%, -30%) rotate(360deg) scale(1.1); }
        }
        @keyframes fluid-orbit-2 {
            0% { transform: translate(30%, 20%) rotate(0deg) scale(1.4); }
            50% { transform: translate(-40%, -20%) rotate(-180deg) scale(1); }
            100% { transform: translate(30%, 20%) rotate(-360deg) scale(1.4); }
        }
        @keyframes siri-text-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes siri-spin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        @keyframes section-border-glow {
            0%, 100% { border-color: rgba(59, 130, 246, 0.2); }
            50% { border-color: rgba(139, 92, 246, 0.4); }
        }

        .bg-fluid-container { position: fixed; inset: 0; background: #000; z-index: -1; overflow: hidden; }
        .bg-blob { position: absolute; width: 140vmax; height: 140vmax; filter: blur(100px); opacity: 0.65; mix-blend-mode: screen; }
        .blob-vivid-1 { background: radial-gradient(circle, rgba(0, 80, 255, 0.8) 0%, transparent 65%); top: -40%; left: -40%; animation: fluid-orbit-1 30s infinite ease-in-out; }
        .blob-vivid-2 { background: radial-gradient(circle, rgba(147, 51, 234, 0.8) 0%, transparent 65%); bottom: -40%; right: -30%; animation: fluid-orbit-2 35s infinite ease-in-out; }
        .blob-vivid-3 { background: radial-gradient(circle, rgba(6, 182, 212, 0.7) 0%, transparent 65%); top: 20%; right: -40%; animation: fluid-orbit-1 32s infinite ease-in-out reverse; }

        .siri-text-effect {
            background: linear-gradient(-45deg, #60a5fa, #a78bfa, #f472b6, #22d3ee, #60a5fa);
            background-size: 400% 400%;
            animation: siri-text-flow 12s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(50px);
            -webkit-backdrop-filter: blur(50px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 2rem;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
            animation: section-border-glow 8s infinite ease-in-out;
        }

        .siri-glow-button {
            position: relative;
            background: #000;
            border: none;
            overflow: hidden;
            z-index: 1;
        }
        .siri-glow-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 150%;
            height: 600%;
            background: conic-gradient(from 0deg, #ff2400, #e81d1d, #e8b71d, #1de840, #1ddde8, #2b1de8, #dd1de8, #ff2400);
            animation: siri-spin 10s linear infinite;
            z-index: -2;
            filter: blur(15px);
            opacity: 0.95;
        }
        .siri-glow-button::after {
            content: '';
            position: absolute;
            inset: 2px;
            background: rgba(5, 5, 10, 0.98);
            border-radius: inherit;
            z-index: -1;
        }

        /* UI調整 */
        *::-webkit-outer-spin-button, *::-webkit-inner-spin-button { -webkit-appearance: none !important; margin: 0 !important; }
        input, textarea, select { -webkit-appearance: none !important; -moz-appearance: textfield !important; appearance: none !important; outline: none !important; }
        textarea::-webkit-scrollbar { display: none !important; }
        textarea { scrollbar-width: none !important; resize: vertical !important; }
        select { background-color: rgba(15, 23, 42, 0.9) !important; color: white !important; }
        select option { background-color: #020617 !important; color: #ffffff !important; }
        
        /* プレースホルダーの色をハッキリさせる */
        ::placeholder { color: #94a3b8 !important; opacity: 1 !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const apiKey = ""; // Runtime provides this

        // 【校正済】表示崩れ・クラッシュを防ぐヘルパー
        const safeSplit = (data) => {
            if (!data) return [];
            if (typeof data === 'string') return data.split('\n');
            if (typeof data === 'object') return Object.entries(data).map(([k, v]) => `${k}：${v}`);
            return [data.toString()];
        };

        // 【校正済】SVGアイコン直接描画（removeChildエラー回避）
        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                'upload': <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>,
                'file': <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z M14 2v6h6"/>,
                'trash-2': <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2 M10 11v6 M14 11v6"/>,
                'chevron-down': <path d="m6 9 6 6 6-6"/>,
                'image': <path d="M3 3h18v18H3z M8.5 8.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z M21 15l-5-5L5 21"/>,
                'maximize': <path d="M8 3H5a2 2 0 0 0-2 2v3 M21 8V5a2 2 0 0 0-2-2h-3 M3 16v3a2 2 0 0 0 2 2h3 M16 21h3a2 2 0 0 0 2-2v-3"/>,
                'download': <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3"/>,
                'loader-2': <path d="M21 12a9 9 0 1 1-6.219-8.56"/>,
                'zoom-in': <g><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></g>,
                'refresh-ccw': <g><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></g>,
                'x': <path d="M18 6 6 18 M6 6l12 12"/>
            };
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        // テキスト整形表示コンポーネント
        const FormattedItem = ({ label, text }) => {
            if (!text || text.toString().trim() === "" || text === "なし" || text === "undefined") return null;
            const cleanText = text.toString().replace(/\*+/g, '').replace(/["']/g, '').trim();
            if (!cleanText) return null;
            return (
                <div className="flex text-sm text-slate-100 leading-relaxed pl-1 mb-4 last:mb-0">
                    <span className="mr-3 text-blue-400 select-none flex-shrink-0 font-bold">・</span>
                    <div className="flex-1">
                        {label && <strong className="text-white border-b border-blue-500/30 mr-2">{label}:</strong>}
                        <span>{cleanText}</span>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [uploadedFiles, setUploadedFiles] = useState([]);
            const [formData, setFormData] = useState({
                target: '', goal: '', size: '16:9', customWidth: '', customHeight: '',
                bgm: 'あり', narration: 'あり', duration: '30', other: ''
            });
            const [result, setResult] = useState(null);
            const [generatingImages, setGeneratingImages] = useState({});
            const [sceneImages, setSceneImages] = useState({});
            const [selectedImage, setSelectedImage] = useState(null);

            const fileInputRef = useRef(null);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                if (['duration', 'customWidth', 'customHeight'].includes(name)) {
                    setFormData(prev => ({ ...prev, [name]: value.replace(/[^0-9]/g, '') }));
                } else {
                    setFormData(prev => ({ ...prev, [name]: value }));
                }
            };

            const handleFileUpload = (e) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setUploadedFiles(prev => [
                            ...prev, 
                            { id: crypto.randomUUID(), name: file.name, type: file.type, data: reader.result, isImage: file.type.startsWith('image/') }
                        ]);
                    };
                    reader.readAsDataURL(file);
                });
            };

            const removeFile = (id) => setUploadedFiles(prev => prev.filter(f => f.id !== id));

            const callGemini = async (prompt, systemInstruction, files = []) => {
                let retries = 0;
                const parts = [{ text: prompt }];
                files.filter(f => f.isImage).forEach(file => {
                    parts.push({ inlineData: { mimeType: file.type, data: file.data.split(',')[1] } });
                });
                while (retries <= 5) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ role: "user", parts: parts }],
                                systemInstruction: { parts: [{ text: systemInstruction }] },
                                generationConfig: {
                                    responseMimeType: "application/json",
                                    responseSchema: {
                                        type: "OBJECT",
                                        properties: {
                                            basicInfo: { type: "string" },
                                            scenes: { 
                                                type: "ARRAY", 
                                                items: { 
                                                    type: "OBJECT", 
                                                    properties: { 
                                                        sceneNumber: { type: "number" }, 
                                                        time: { type: "string" },
                                                        summary: { type: "string" },
                                                        audio: { type: "string" },
                                                        narration: { type: "string" },
                                                        visualPromptJp: { type: "string" },
                                                        visualPromptEn: { type: "string" }
                                                    },
                                                    required: ["sceneNumber", "time", "summary", "audio", "narration", "visualPromptJp", "visualPromptEn"]
                                                } 
                                            },
                                            editingNotes: { type: "string" }
                                        },
                                        required: ["basicInfo", "scenes", "editingNotes"]
                                    }
                                }
                            })
                        });
                        const data = await response.json();
                        let rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (!rawText) throw new Error('Empty response');
                        const start = rawText.indexOf('{');
                        const end = rawText.lastIndexOf('}');
                        return JSON.parse(rawText.substring(start, end + 1));
                    } catch (err) {
                        if (retries === 5) throw err;
                        await new Promise(r => setTimeout(r, Math.pow(2, retries) * 1000));
                        retries++;
                    }
                }
            };

            const generateImage = async (englishPrompt, sceneIndex, size) => {
                setGeneratingImages(prev => ({ ...prev, [sceneIndex]: true }));
                let aspectRatio = "1:1";
                if(size.includes("16:9")) aspectRatio = "16:9";
                else if(size.includes("9:16")) aspectRatio = "9:16";
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            instances: [{ 
                                /* 【強力校正：日本語描画プッシュ】中国語を完全に排除し、標準日本語フォントのみをプッシュ */
                                prompt: `STRICT MANDATORY REQUIREMENT: Display the Japanese Kanji/Kana text precisely using Standard Japanese Typography fonts. 
                                ABSOLUTE CONSTRAINT: DO NOT USE CHINESE STYLE FONTS OR CHINESE CHARACTERS. NO SIMPLIFIED CHINESE. 
                                THE TARGET TEXT CONTENT IS: ${englishPrompt}.
                                Visual Style: Luxury cinematic motion graphics design. Flat premium vectors, 8k render. NO PHOTOGRAPHY.` 
                            }],
                            parameters: { sampleCount: 1, aspectRatio: aspectRatio }
                        })
                    });
                    const data = await response.json();
                    if (data.predictions?.[0]) {
                        setSceneImages(prev => ({ ...prev, [sceneIndex]: `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}` }));
                    }
                } catch (err) {
                    setError("ビジュアルの生成に失敗しました。");
                } finally {
                    setGeneratingImages(prev => ({ ...prev, [sceneIndex]: false }));
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError(null);
                setResult(null);
                setSceneImages({});
                const systemInstruction = `あなたはプロの映像ディレクター。
                1. 概要 (summary): 演出意図、カメラワークを150文字以上で具体的に記述せよ。
                2. 表示順序: 出力データは必ず「秒数 → 概要 → 音声 → ナレーション」の順で整理せよ。
                3. シーン数: 尺に応じて最低6〜8枚。
                4. 禁止: マークダウン記号、実写、中国語フォント。
                5. 文字指定: englishPromptの先頭に「Must featured the text '[指定の日本語]' precisely in high-quality Japanese typography」と明記せよ。
                6. 形式: JSONのみ。`;
                try {
                    const actualSize = formData.size === 'その他' ? `${formData.customWidth}x${formData.customHeight}px` : formData.size;
                    const data = await callGemini(`案件定義: ターゲット:${formData.target}, ゴール:${formData.goal}, 尺:${formData.duration}秒, 特記:${formData.other}, サイズ:${actualSize}`, systemInstruction, uploadedFiles);
                    setResult(data);
                } catch (err) {
                    setError("指示書の生成中にエラーが発生しました。");
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen relative overflow-x-hidden" style={{fontFamily: '"Noto Sans JP", sans-serif'}}>
                    <div className="bg-fluid-container">
                        <div className="bg-blob blob-vivid-1"></div>
                        <div className="bg-blob blob-vivid-2"></div>
                        <div className="bg-blob blob-vivid-3"></div>
                        <div className="absolute inset-0 bg-black/40 pointer-events-none"></div>
                    </div>

                    <div className="max-w-4xl mx-auto p-4 md:p-10 relative z-10">
                        <header className="mb-12 text-center">
                            <h1 className="text-xl md:text-2xl font-black mb-4 tracking-[0.5em] uppercase py-2 siri-text-effect">IFM AI Planner</h1>
                            <p className="font-bold text-[9px] tracking-[0.6em] uppercase text-slate-400 opacity-80">Storyboard & Creative Direction</p>
                        </header>

                        {/* STEP 1: 資料解析 (復旧・校正済み) */}
                        <section className="glass-card p-6 md:p-10 mb-8">
                            <div className="flex items-center gap-3 mb-8">
                                <div className="bg-blue-600 text-white w-7 h-7 rounded-full flex items-center justify-center font-black shadow-lg text-xs">1</div>
                                <h2 className="text-xl font-black tracking-tight text-white/90">デザイン素材の解析</h2>
                            </div>
                            <div className="border-2 border-dashed border-white/20 rounded-3xl p-10 hover:border-blue-400/50 bg-white/5 cursor-pointer text-center group transition-all" onClick={() => fileInputRef.current.click()}>
                                <div className="bg-white/10 text-white w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform"><Icon name="upload" size={32} /></div>
                                <p className="text-white font-black mb-1 text-sm tracking-wide">ロゴやチラシ資料をアップロード</p>
                                <input type="file" ref={fileInputRef} className="hidden" multiple onChange={handleFileUpload} />
                            </div>
                            {uploadedFiles.length > 0 && (
                                <div className="mt-8 grid grid-cols-2 sm:grid-cols-4 gap-4 animate-in fade-in zoom-in-95">
                                    {uploadedFiles.map(f => (
                                        <div key={f.id} className="relative bg-white/10 border border-white/10 rounded-2xl p-3 group overflow-hidden shadow-2xl">
                                            {f.isImage ? <img src={f.data} className="w-full aspect-square object-cover rounded-xl" /> : <div className="flex justify-center items-center h-full aspect-square bg-black/20 rounded-xl"><Icon name="file" size={32} /></div>}
                                            <button onClick={() => removeFile(f.id)} className="absolute top-2 right-2 bg-slate-900/90 p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-all hover:bg-red-500 shadow-xl border border-white/10"><Icon name="trash-2" size={14} /></button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </section>

                        {/* STEP 2: 案件要件 (校正・参考例復旧済み) */}
                        <section className="glass-card p-6 md:p-10 mb-12">
                            <div className="flex items-center gap-3 mb-10">
                                <div className="bg-blue-600 text-white w-7 h-7 rounded-full flex items-center justify-center font-black shadow-lg text-xs">2</div>
                                <h2 className="text-xl font-black tracking-tight text-white/90">案件要件の定義</h2>
                            </div>
                            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div className="space-y-6">
                                    <div>
                                        <label className="text-[10px] font-black mb-2 text-slate-300 block ml-1 uppercase tracking-widest">ターゲット</label>
                                        <input type="text" name="target" required className="w-full px-4 py-3.5 bg-white/5 border border-white/10 rounded-2xl text-sm font-bold" placeholder="例：30代のファミリー層" value={formData.target} onChange={handleInputChange} />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black mb-2 text-slate-300 block ml-1 uppercase tracking-widest">目的</label>
                                        <input type="text" name="goal" required className="w-full px-4 py-3.5 bg-white/5 border border-white/10 rounded-2xl text-sm font-bold" placeholder="例：新商品の認知拡大" value={formData.goal} onChange={handleInputChange} />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black mb-2 text-slate-300 block ml-1 uppercase tracking-widest">画面サイズ</label>
                                        <div className="space-y-4">
                                            <div className="relative group">
                                                <select name="size" className="w-full px-4 py-3.5 bg-slate-950 border border-white/10 rounded-2xl text-sm font-bold appearance-none" value={formData.size} onChange={handleInputChange}>
                                                    <option value="16:9">横長 (16:9)</option><option value="9:16">縦長 (9:16)</option><option value="1:1">正方形 (1:1)</option><option value="その他">その他</option>
                                                </select>
                                                <Icon name="chevron-down" className="absolute right-5 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400 group-hover:text-blue-400" size={20} />
                                            </div>
                                            {formData.size === 'その他' && (
                                                <div className="flex items-center gap-3 p-4 bg-white/5 border border-white/10 rounded-2xl animate-in slide-in-from-top-2">
                                                    <div className="flex-1 text-center"><input type="text" name="customWidth" required className="w-full bg-black/40 border border-white/10 rounded-xl p-2.5 text-xs text-center font-bold" placeholder="横(px)" value={formData.customWidth} onChange={handleInputChange} /></div>
                                                    <span className="text-slate-500 font-bold">×</span>
                                                    <div className="flex-1 text-center"><input type="text" name="customHeight" required className="w-full bg-black/40 border border-white/10 rounded-xl p-2.5 text-xs text-center font-bold" placeholder="縦(px)" value={formData.customHeight} onChange={handleInputChange} /></div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                                <div className="space-y-6">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-[10px] font-black mb-2 text-slate-300 block tracking-widest">BGM</label><select name="bgm" className="w-full px-4 py-3.5 bg-slate-950 border border-white/10 rounded-2xl text-sm font-bold appearance-none" value={formData.bgm} onChange={handleInputChange}><option value="あり">あり</option><option value="なし">なし</option></select></div>
                                        <div><label className="text-[10px] font-black mb-2 text-slate-300 block tracking-widest">ナレーション</label><select name="narration" className="w-full px-4 py-3.5 bg-slate-950 border border-white/10 rounded-2xl text-sm font-bold appearance-none" value={formData.narration} onChange={handleInputChange}><option value="あり">あり</option><option value="なし">なし</option></select></div>
                                    </div>
                                    <div><label className="text-[10px] font-black mb-2 text-slate-300 block tracking-widest">秒数</label><div className="relative"><input type="text" name="duration" className="w-full px-4 py-3.5 bg-white/5 border border-white/10 rounded-2xl text-sm font-bold pr-12" placeholder="例：30" value={formData.duration} onChange={handleInputChange} /><span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-black text-[10px]">秒</span></div></div>
                                    <div><label className="text-[10px] font-black mb-2 text-slate-300 block tracking-widest">特記事項</label><textarea name="other" className="w-full px-4 py-3.5 bg-white/5 border border-white/10 rounded-2xl text-sm h-[52px] font-bold" placeholder="例：和モダンな明るい印象で。" value={formData.other} onChange={handleInputChange} /></div>
                                </div>
                                <div className="md:col-span-2 mt-4"><button type="submit" disabled={loading} className="w-full py-6 rounded-3xl transition-all shadow-2xl siri-glow-button font-black uppercase tracking-[0.5em] text-sm active:scale-95">{loading ? "構成案を構成中..." : "制作指示書を出力する"}</button></div>
                            </form>
                        </section>

                        {/* RESULT SECTION (再校正済み) */}
                        {result && (
                            <div className="space-y-24 pb-32 animate-in fade-in slide-in-from-bottom-8 duration-700">
                                <section>
                                    <h2 className="text-2xl font-black uppercase tracking-tight mb-5 px-3">・基本情報</h2>
                                    <div className="glass-card p-10">
                                        {safeSplit(result.basicInfo).map((line, i) => (
                                            <FormattedItem key={i} text={line} />
                                        ))}
                                    </div>
                                </section>

                                <section className="space-y-24">
                                    {result.scenes.map((s, idx) => (
                                        <div key={idx} className="space-y-12 animate-in fade-in">
                                            {/* 台本: 秒数 → 概要 → 音声 → ナレーション (校正済み) */}
                                            <div className="glass-card overflow-hidden shadow-[0_10px_40px_rgba(0,0,0,0.4)]">
                                                <div className="bg-white/5 p-4 border-b border-white/10 px-6"><span className="font-black text-[10px] text-blue-400 uppercase font-mono tracking-widest">シーン {s.sceneNumber} 構成台本</span></div>
                                                <div className="p-8">
                                                    <FormattedItem label="秒数" text={s.time} />
                                                    <FormattedItem label="概要" text={s.summary} />
                                                    <FormattedItem label="音声" text={s.audio} />
                                                    <FormattedItem label="ナレーション" text={s.narration} />
                                                </div>
                                            </div>
                                            {/* ビジュアル指示 */}
                                            <div className="glass-card overflow-hidden relative max-w-2xl mx-auto border-cyan-500/20 border-2 shadow-[0_0_40px_rgba(6,182,212,0.15)] transition-transform hover:-translate-y-1">
                                                <div className="bg-black/40 p-4 border-b border-white/10 px-6 flex justify-between"><span className="text-[10px] font-black tracking-widest uppercase font-mono">シーン {s.sceneNumber} ビジュアル指示</span></div>
                                                <div className="p-6 flex flex-col items-center">
                                                    <div className="bg-white/5 p-5 rounded-xl mb-6 border border-white/5 w-full text-center"><p className="text-xs text-slate-200 leading-relaxed italic opacity-80 whitespace-pre-wrap">{s.visualPromptJp}</p></div>
                                                    <div className="relative aspect-video w-full bg-black/50 rounded-2xl overflow-hidden cursor-pointer flex items-center justify-center group/img" onClick={() => sceneImages[idx] && setSelectedImage(sceneImages[idx])}>
                                                        {sceneImages[idx] ? (
                                                            <>
                                                                <img src={sceneImages[idx]} className="w-full h-full object-cover transition-transform duration-1000" />
                                                                <div className="absolute inset-0 bg-black/60 opacity-0 hover:opacity-100 transition-all flex items-center justify-center gap-6 backdrop-blur-sm">
                                                                    <Icon name="zoom-in" size={28} className="text-white" />
                                                                    <div className="bg-white text-black p-2.5 rounded-full shadow-2xl active:scale-90 hover:scale-110 transition-transform" onClick={(e) => { e.stopPropagation(); const link = document.createElement('a'); link.href = sceneImages[idx]; link.download = `scene_${s.sceneNumber}.png`; link.click(); }}><Icon name="download" size={20} /></div>
                                                                    <div className="bg-blue-600 text-white p-2.5 rounded-full shadow-2xl active:scale-90 hover:scale-110 transition-transform" onClick={(e) => { e.stopPropagation(); generateImage(s.visualPromptEn, idx, formData.size); }}><Icon name="refresh-ccw" size={18} /></div>
                                                                </div>
                                                            </>
                                                        ) : (
                                                            <div className="w-full h-full flex flex-col items-center justify-center bg-white/5 hover:bg-white/10 transition-colors">
                                                                <button 
                                                                    onClick={(e) => { e.stopPropagation(); generateImage(s.visualPromptEn, idx, formData.size); }} 
                                                                    className="flex flex-col items-center justify-center group/btn relative w-full h-full"
                                                                    disabled={generatingImages[idx]}
                                                                >
                                                                    {generatingImages[idx] ? (
                                                                        <div className="flex flex-col items-center justify-center">
                                                                            <Icon name="loader-2" size={48} className="animate-spin text-blue-400 mb-4" />
                                                                            <span className="text-[10px] font-black text-blue-200 uppercase tracking-widest animate-pulse">Rendering...</span>
                                                                        </div>
                                                                    ) : (
                                                                        <div className="flex flex-col items-center justify-center">
                                                                            <div className="p-5 bg-white/10 rounded-full mb-4 group-hover/btn:scale-110 transition-transform border border-white/5 shadow-lg"><Icon name="image" size={32} /></div>
                                                                            <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">ビジュアル生成</span>
                                                                        </div>
                                                                    )}
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </section>
                                <section>
                                    <h2 className="text-2xl font-black uppercase tracking-tight mb-5 px-3">・技術ノート</h2>
                                    <div className="glass-card p-10 space-y-2">
                                        {safeSplit(result.editingNotes).map((line, i) => (
                                            <FormattedItem key={i} text={line} />
                                        ))}
                                    </div>
                                </section>
                            </div>
                        )}
                    </div>

                    {/* 【再校正済】拡大モーダル：×ボタンの視認性を最大化 (z-index 1100) */}
                    {selectedImage && (
                        <div className="fixed inset-0 z-[1000] bg-black/95 backdrop-blur-3xl flex items-center justify-center p-4 md:p-12 animate-in fade-in duration-300" onClick={() => setSelectedImage(null)}>
                            <button className="absolute top-8 right-8 text-black bg-white p-3 rounded-full z-[1100] border-2 border-black shadow-[0_0_60px_rgba(255,255,255,0.7)] active:scale-90 hover:bg-slate-200 transition-colors flex items-center justify-center">
                                <Icon name="x" size={32} />
                            </button>
                            <img src={selectedImage} className="max-w-full max-h-full rounded-2xl shadow-[0_0_150px_rgba(0,0,0,1)] object-contain border border-white/10" onClick={(e) => e.stopPropagation()} />
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

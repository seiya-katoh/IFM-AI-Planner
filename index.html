<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFM AI Planner</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root { color-scheme: dark; }
        body { 
            background-color: #000; 
            margin: 0; 
            font-family: 'Noto Sans JP', sans-serif;
            overflow-x: hidden;
        }

        /* --- Siri調流動背景アニメーション --- */
        @keyframes fluid-orbit-1 {
            0% { transform: translate(-30%, -30%) rotate(0deg) scale(1.1); }
            50% { transform: translate(30%, 30%) rotate(180deg) scale(1.6); }
            100% { transform: translate(-30%, -30%) rotate(360deg) scale(1.1); }
        }
        @keyframes fluid-orbit-2 {
            0% { transform: translate(30%, 20%) rotate(0deg) scale(1.4); }
            50% { transform: translate(-40%, -20%) rotate(-180deg) scale(1); }
            100% { transform: translate(30%, 20%) rotate(-360deg) scale(1.4); }
        }
        @keyframes siri-text-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes siri-spin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        @keyframes section-border-glow {
            0%, 100% { border-color: rgba(59, 130, 246, 0.2); }
            50% { border-color: rgba(139, 92, 246, 0.4); }
        }

        .bg-fluid-container { 
            position: fixed; 
            inset: 0; 
            background: #000; 
            z-index: -1; 
            overflow: hidden; 
        }
        .bg-blob { 
            position: absolute; 
            width: 140vmax; 
            height: 140vmax; 
            filter: blur(100px); 
            opacity: 0.65; 
            mix-blend-mode: screen; 
        }
        .blob-vivid-1 { background: radial-gradient(circle, rgba(0, 80, 255, 0.8) 0%, transparent 65%); top: -40%; left: -40%; animation: fluid-orbit-1 30s infinite ease-in-out; }
        .blob-vivid-2 { background: radial-gradient(circle, rgba(147, 51, 234, 0.8) 0%, transparent 65%); bottom: -40%; right: -30%; animation: fluid-orbit-2 35s infinite ease-in-out; }
        .blob-vivid-3 { background: radial-gradient(circle, rgba(6, 182, 212, 0.7) 0%, transparent 65%); top: 20%; right: -40%; animation: fluid-orbit-1 32s infinite ease-in-out reverse; }

        .siri-text-effect {
            background: linear-gradient(-45deg, #60a5fa, #a78bfa, #f472b6, #22d3ee, #60a5fa);
            background-size: 400% 400%;
            animation: siri-text-flow 12s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(50px);
            -webkit-backdrop-filter: blur(50px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 2rem;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
            animation: section-border-glow 8s infinite ease-in-out;
        }

        .siri-glow-button {
            position: relative;
            background: #000;
            border: none;
            overflow: hidden;
            z-index: 1;
        }
        .siri-glow-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 150%;
            height: 600%;
            background: conic-gradient(from 0deg, #ff2400, #e81d1d, #e8b71d, #1de840, #1ddde8, #2b1de8, #dd1de8, #ff2400);
            animation: siri-spin 12s linear infinite;
            z-index: -2;
            filter: blur(15px);
            opacity: 0.95;
        }
        .siri-glow-button::after {
            content: '';
            position: absolute;
            inset: 2px;
            background: rgba(5, 5, 10, 0.98);
            border-radius: inherit;
            z-index: -1;
        }

        *::-webkit-outer-spin-button, *::-webkit-inner-spin-button {
            -webkit-appearance: none !important;
            margin: 0 !important;
        }
        input, textarea, select {
            -webkit-appearance: none !important;
            -moz-appearance: textfield !important;
            appearance: none !important;
            outline: none !important;
        }
        textarea::-webkit-scrollbar { display: none !important; }
        textarea { scrollbar-width: none !important; resize: vertical !important; }
        select { background-color: rgba(15, 23, 42, 0.9) !important; color: white !important; }
        select option { background-color: #020617 !important; color: #ffffff !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const apiKey = ""; // Runtime provides this

        const titleFontStyle = { fontFamily: '"Helvetica Neue", "Helvetica", "Arial", sans-serif' };

        // アイコンコンポーネント
        const Icon = ({ name, size = 24, className = "" }) => {
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        // 強化された箇条書きレンダラー
        const FormattedText = ({ text }) => {
            if (!text) return null;

            let contentToRender = text;

            // JSONが文字列として混入した場合の救済
            if (typeof text === 'string' && text.trim().startsWith('{')) {
                try {
                    const obj = JSON.parse(text);
                    contentToRender = Object.entries(obj)
                        .map(([k, v]) => `・${k}：${v}`)
                        .join('\n');
                } catch (e) {}
            } else if (typeof text === 'object') {
                contentToRender = Object.entries(text)
                    .map(([k, v]) => `・${k}：${v}`)
                    .join('\n');
            }

            const formattedText = contentToRender.toString()
                .replace(/[・]{1,}/g, '\n・') 
                .replace(/^\n/, ''); 
            
            const lines = formattedText.split(/\r?\n/)
                .map(l => l.trim())
                .filter(l => l.length > 0 && !l.match(/^シーン\s*\d+$/) && l !== '{' && l !== '}');
            
            return (
                <div className="space-y-3">
                    {lines.map((line, i) => {
                        const cleanLine = line.replace(/^[・\-*]\s*/, "").replace(/^"|"$/g, "").replace(/"/g, '');
                        const parts = cleanLine.split(/(\*\*.*?\*\*)/g);
                        
                        return (
                            <div key={i} className="flex text-sm text-slate-100 leading-relaxed pl-1">
                                <span className="mr-3 text-blue-400 select-none flex-shrink-0 font-bold">・</span>
                                <div className="flex-1">
                                    {parts.map((part, j) => {
                                        if (part.startsWith('**') && part.endsWith('**')) {
                                            return <strong key={j} className="font-black text-white border-b border-blue-500/40">{part.slice(2, -2)}</strong>;
                                        }
                                        return part;
                                    })}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const App = () => {
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [uploadedFiles, setUploadedFiles] = useState([]);
            const [formData, setFormData] = useState({
                target: '', goal: '', size: '16:9', customWidth: '', customHeight: '',
                bgm: 'あり', narration: 'あり', duration: '30', other: ''
            });
            const [result, setResult] = useState(null);
            const [generatingImages, setGeneratingImages] = useState({});
            const [sceneImages, setSceneImages] = useState({});
            const [selectedImage, setSelectedImage] = useState(null);

            const fileInputRef = useRef(null);

            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [result, loading, uploadedFiles]);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                if (['duration', 'customWidth', 'customHeight'].includes(name)) {
                    setFormData(prev => ({ ...prev, [name]: value.replace(/[^0-9]/g, '') }));
                } else {
                    setFormData(prev => ({ ...prev, [name]: value }));
                }
            };

            const handleFileUpload = (e) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setUploadedFiles(prev => [
                            ...prev, 
                            { id: Math.random().toString(36), name: file.name, type: file.type, data: reader.result, isImage: file.type.startsWith('image/') }
                        ]);
                    };
                    reader.readAsDataURL(file);
                });
            };

            const removeFile = (id) => setUploadedFiles(prev => prev.filter(f => f.id !== id));

            const callGemini = async (prompt, systemInstruction, files = []) => {
                let retries = 0;
                const parts = [{ text: prompt }];
                files.filter(f => f.isImage).forEach(file => {
                    parts.push({ inlineData: { mimeType: file.type, data: file.data.split(',')[1] } });
                });

                while (retries <= 5) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ role: "user", parts: parts }],
                                systemInstruction: { parts: [{ text: systemInstruction }] },
                                generationConfig: {
                                    responseMimeType: "application/json",
                                    responseSchema: {
                                        type: "OBJECT",
                                        properties: {
                                            basicInfo: { type: "string" },
                                            scriptScenes: { type: "ARRAY", items: { type: "OBJECT", properties: { sceneNumber: { type: "number" }, content: { type: "string" } } } },
                                            editingNotes: { type: "string" },
                                            imagePrompts: { type: "ARRAY", items: { type: "OBJECT", properties: { sceneNumber: { type: "number" }, japanesePrompt: { type: "string" }, englishPrompt: { type: "string" } } } }
                                        },
                                        required: ["basicInfo", "scriptScenes", "editingNotes", "imagePrompts"]
                                    }
                                }
                            })
                        });
                        const data = await response.json();
                        return JSON.parse(data.candidates[0].content.parts[0].text);
                    } catch (err) {
                        if (retries === 5) throw err;
                        await new Promise(r => setTimeout(r, Math.pow(2, retries) * 1000));
                        retries++;
                    }
                }
            };

            const generateImage = async (englishPrompt, sceneIndex, size) => {
                setGeneratingImages(prev => ({ ...prev, [sceneIndex]: true }));
                let aspectRatio = "1:1";
                if(size.includes("16:9")) aspectRatio = "16:9";
                if(size.includes("9:16")) aspectRatio = "9:16";

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            instances: [{ prompt: `High-end professional motion graphics: ${englishPrompt}. CRITICAL: Standard Japanese text only. 8k render.` }],
                            parameters: { sampleCount: 1, aspectRatio: aspectRatio }
                        })
                    });
                    const data = await response.json();
                    setSceneImages(prev => ({ ...prev, [sceneIndex]: `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}` }));
                } catch (err) {
                    setError("画像の生成に失敗しました。");
                } finally {
                    setGeneratingImages(prev => ({ ...prev, [sceneIndex]: false }));
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError(null);
                setResult(null);
                setSceneImages({});

                const systemInstruction = `アートディレクターとして高品質な制作指示書を作成せよ。
                1. 整合性: 台本シーン数と画像プロンプト数は必ず一致。
                2. basicInfo: JSON禁止。純粋な「・項目名：内容」のテキスト形式で返せ。
                3. 言語分離: japanesePromptは日本語説明のみ。Render等の英文指示はenglishPromptのみに入れる。`;

                try {
                    const actualSize = formData.size === 'その他' ? `${formData.customWidth}x${formData.customHeight}px` : formData.size;
                    const data = await callGemini(`ターゲット:${formData.target}, ゴール:${formData.goal}, サイズ:${actualSize}`, systemInstruction, uploadedFiles);
                    setResult(data);
                } catch (err) {
                    setError("生成エラーが発生しました。");
                } finally {
                    setLoading(false);
                }
            };

            const copyToClipboard = (text) => {
                const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
            };

            return (
                <div className="min-h-screen relative overflow-x-hidden text-white">
                    <div className="bg-fluid-container">
                        <div className="bg-blob blob-vivid-1"></div>
                        <div className="bg-blob blob-vivid-2"></div>
                        <div className="bg-blob blob-vivid-3"></div>
                        <div className="absolute inset-0 bg-black/40"></div>
                    </div>

                    <div className="max-w-4xl mx-auto p-4 md:p-10 relative z-10">
                        <header className="mb-12 text-center">
                            <h1 className="text-xl md:text-2xl font-black mb-4 tracking-[0.5em] uppercase drop-shadow-[0_4px_30px_rgba(0,0,0,1)] py-2 siri-text-effect" style={titleFontStyle}>IFM AI Planner</h1>
                            <p className="font-bold text-[9px] tracking-[0.6em] uppercase text-slate-400 opacity-80">Storyboard & Creative Direction</p>
                        </header>

                        <section className="glass-card p-6 md:p-10 mb-8">
                            <div className="flex items-center gap-3 mb-8">
                                <div className="bg-blue-600 text-white w-7 h-7 rounded-full flex items-center justify-center font-black shadow-lg text-xs">1</div>
                                <h2 className="text-xl font-black tracking-tight text-white/90">デザイン素材の解析</h2>
                            </div>
                            <div className="border-2 border-dashed border-white/20 rounded-3xl p-10 hover:border-blue-400/50 bg-white/5 cursor-pointer text-center group transition-all" onClick={() => fileInputRef.current.click()}>
                                <div className="bg-white/10 text-white w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform"><Icon name="upload" size={32} /></div>
                                <p className="text-white font-black mb-1 text-sm">資料をアップロード</p>
                                <input type="file" ref={fileInputRef} className="hidden" multiple onChange={handleFileUpload} />
                            </div>
                            {uploadedFiles.length > 0 && (
                                <div className="mt-8 grid grid-cols-2 sm:grid-cols-4 gap-4">
                                    {uploadedFiles.map(f => (
                                        <div key={f.id} className="relative bg-white/10 border border-white/10 rounded-2xl p-3 group">
                                            {f.isImage ? <img src={f.data} className="w-full aspect-square object-cover rounded-xl" /> : <Icon name="file" size={32} className="mx-auto" />}
                                            <button onClick={() => removeFile(f.id)} className="absolute -top-2 -right-2 bg-slate-900 p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-all"><Icon name="trash-2" size={12} /></button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </section>

                        <section className="glass-card p-6 md:p-10 mb-12">
                            <div className="flex items-center gap-3 mb-10">
                                <div className="bg-blue-600 text-white w-7 h-7 rounded-full flex items-center justify-center font-black shadow-lg text-xs">2</div>
                                <h2 className="text-xl font-black tracking-tight text-white/90">案件要件の定義</h2>
                            </div>
                            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div className="space-y-6">
                                    <div>
                                        <label className="text-[10px] font-black mb-2 text-slate-300 uppercase tracking-widest block">ターゲット</label>
                                        <input type="text" name="target" required className="w-full px-4 py-3.5 bg-white/5 border border-white/10 rounded-2xl text-sm" value={formData.target} onChange={handleInputChange} />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black mb-2 text-slate-300 uppercase tracking-widest block">動画の目的</label>
                                        <input type="text" name="goal" required className="w-full px-4 py-3.5 bg-white/5 border border-white/10 rounded-2xl text-sm" value={formData.goal} onChange={handleInputChange} />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black mb-2 text-slate-300 uppercase tracking-widest block">画面サイズ</label>
                                        <div className="relative">
                                            <select name="size" className="w-full px-4 py-3.5 bg-slate-950 border border-white/10 rounded-2xl text-sm appearance-none" value={formData.size} onChange={handleInputChange}>
                                                <option value="16:9">横長 (16:9)</option>
                                                <option value="9:16">縦長 (9:16)</option>
                                                <option value="1:1">正方形 (1:1)</option>
                                                <option value="その他">その他</option>
                                            </select>
                                            <Icon name="chevron-down" size={18} className="absolute right-4 top-4 text-slate-400" />
                                        </div>
                                    </div>
                                </div>
                                <div className="space-y-6">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-[10px] font-black mb-2 text-slate-300 uppercase tracking-widest block">BGM</label>
                                            <select name="bgm" className="w-full px-4 py-3.5 bg-slate-950 border border-white/10 rounded-2xl text-sm appearance-none" value={formData.bgm} onChange={handleInputChange}>
                                                <option value="あり">あり</option><option value="なし">なし</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-black mb-2 text-slate-300 uppercase tracking-widest block">ナレーション</label>
                                            <select name="narration" className="w-full px-4 py-3.5 bg-slate-950 border border-white/10 rounded-2xl text-sm appearance-none" value={formData.narration} onChange={handleInputChange}>
                                                <option value="あり">あり</option><option value="なし">なし</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black mb-2 text-slate-300 uppercase tracking-widest block">秒数</label>
                                        <input type="text" name="duration" className="w-full px-4 py-3.5 bg-white/5 border border-white/10 rounded-2xl text-sm" value={formData.duration} onChange={handleInputChange} />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black mb-2 text-slate-300 uppercase tracking-widest block">その他</label>
                                        <textarea name="other" className="w-full px-4 py-4 bg-white/5 border border-white/10 rounded-2xl text-sm h-[56px]" value={formData.other} onChange={handleInputChange} />
                                    </div>
                                </div>
                                <div className="md:col-span-2 mt-4">
                                    <button type="submit" disabled={loading} className="w-full py-6 rounded-3xl transition-all shadow-2xl siri-glow-button font-black uppercase tracking-[0.5em] text-sm">
                                        {loading ? "生成中..." : "制作指示書を出力する"}
                                    </button>
                                </div>
                            </form>
                        </section>

                        {result && (
                            <div className="space-y-16 pb-32">
                                <section>
                                    <div className="flex items-center justify-between mb-5 px-3">
                                        <h2 className="text-2xl font-black uppercase tracking-tight">・基本情報</h2>
                                        <button onClick={() => copyToClipboard(result.basicInfo)} className="bg-white/10 px-5 py-2 rounded-xl text-[9px] border border-white/10 uppercase tracking-widest">すべてコピー</button>
                                    </div>
                                    <div className="glass-card p-10"><FormattedText text={result.basicInfo} /></div>
                                </section>

                                <section>
                                    <h2 className="text-2xl font-black uppercase tracking-tight mb-8">・構成台本</h2>
                                    <div className="space-y-6">
                                        {result.scriptScenes.map((s, idx) => (
                                            <div key={idx} className="glass-card overflow-hidden">
                                                <div className="bg-white/5 p-4 flex items-center justify-between border-b border-white/10">
                                                    <span className="font-black text-[10px] text-blue-400 tracking-widest">シーン {s.sceneNumber}</span>
                                                    <button onClick={() => copyToClipboard(s.content)} className="text-[10px] font-black text-slate-400">シーンをコピー</button>
                                                </div>
                                                <div className="p-8"><FormattedText text={s.content} /></div>
                                            </div>
                                        ))}
                                    </div>
                                </section>

                                <section>
                                    <div className="flex items-center justify-between mb-5 px-3">
                                        <h2 className="text-2xl font-black uppercase tracking-tight">・編集指示／技術ノート</h2>
                                        <button onClick={() => copyToClipboard(result.editingNotes)} className="bg-white/10 px-5 py-2 rounded-xl text-[9px] border border-white/10 uppercase tracking-widest">すべてコピー</button>
                                    </div>
                                    <div className="glass-card p-10"><FormattedText text={result.editingNotes} /></div>
                                </section>

                                <section>
                                    <h2 className="text-2xl font-black uppercase tracking-tight mb-12 border-b-4 border-cyan-400/40 pb-5">・各シーン毎の画像生成プロンプト</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
                                        {result.imagePrompts.map((p, idx) => (
                                            <div key={idx} className="glass-card overflow-hidden">
                                                <div className="bg-black/40 p-5 flex items-center justify-between border-b border-white/10">
                                                    <span className="text-[10px] font-black tracking-widest">シーン {p.sceneNumber} ビジュアル</span>
                                                    <button onClick={() => copyToClipboard(p.japanesePrompt)} className="text-[10px] font-black text-slate-400">プロンプトをコピー</button>
                                                </div>
                                                <div className="p-8">
                                                    <div className="bg-white/5 p-6 rounded-2xl mb-8 border border-white/5 min-h-[140px] flex items-center">
                                                        <p className="text-xs text-slate-100 leading-relaxed italic opacity-80">{p.japanesePrompt}</p>
                                                    </div>
                                                    <div className="relative aspect-video bg-black/50 rounded-3xl flex items-center justify-center overflow-hidden cursor-pointer" onClick={() => sceneImages[idx] && setSelectedImage(sceneImages[idx])}>
                                                        {sceneImages[idx] ? (
                                                            <>
                                                                <img src={sceneImages[idx]} className="w-full h-full object-cover" />
                                                                <div className="absolute inset-0 bg-black/60 opacity-0 hover:opacity-100 transition-all flex items-center justify-center gap-6">
                                                                    <Icon name="maximize" size={28} className="text-white" />
                                                                </div>
                                                            </>
                                                        ) : (
                                                            <button onClick={(e) => { e.stopPropagation(); generateImage(p.englishPrompt, idx, formData.size); }} className="flex flex-col items-center">
                                                                {generatingImages[idx] ? <Icon name="loader-2" className="animate-spin text-blue-400" /> : <Icon name="image" size={32} />}
                                                                <span className="text-[10px] mt-2 font-black text-slate-400">ビジュアル生成</span>
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </section>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
